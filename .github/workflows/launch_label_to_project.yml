name: "Launch: Issue Intake"

on:
  issues:
    types: [opened, reopened, closed]

jobs:
  add_to_project:
    if: ${{ contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.issue.author_association) }}
    runs-on: ubuntu-latest
    permissions:
      issues: read
      repository-projects: write
    env:
      LAUNCH_PROJECT_OWNER: its-DeFine
      LAUNCH_PROJECT_NUMBER: "2"

    steps:
      - name: Add/update issue in Launch project and set Status
        env:
          GH_TOKEN: ${{ secrets.LAUNCH_FACTORY_GH_TOKEN }}
        run: |
          set -euo pipefail

          if [[ -z "${GH_TOKEN}" ]]; then
            echo "Missing required secret LAUNCH_FACTORY_GH_TOKEN; cannot add issues to Launch project." >&2
            exit 1
          fi

          ACTION="${{ github.event.action }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          PROJECT_NUMBER="${LAUNCH_PROJECT_NUMBER}"
          PROJECT_OWNER="${LAUNCH_PROJECT_OWNER}"

          if [[ "${ACTION}" == "closed" ]]; then
            STATUS_NAME="Done"
          else
            STATUS_NAME="Inbox"
          fi

          ITEM_ID="$(gh project item-add "${PROJECT_NUMBER}" --owner "${PROJECT_OWNER}" --url "${ISSUE_URL}" --format json --jq '.id' 2>/dev/null || true)"
          if [[ -z "${ITEM_ID}" ]]; then
            ITEM_ID="$(gh project item-list "${PROJECT_NUMBER}" --owner "${PROJECT_OWNER}" --limit 200 --format json --jq ".items[] | select(.content.url==\"${ISSUE_URL}\") | .id" | head -n 1)"
          fi
          if [[ -z "${ITEM_ID}" ]]; then
            echo "Could not locate project item for ${ISSUE_URL}; skipping."
            exit 0
          fi

          PROJECT_ID="$(gh project view "${PROJECT_NUMBER}" --owner "${PROJECT_OWNER}" --format json --jq '.id')"
          STATUS_FIELD_ID="$(gh project field-list "${PROJECT_NUMBER}" --owner "${PROJECT_OWNER}" --format json --jq '.fields[] | select(.name=="Status") | .id')"
          OPTION_ID="$(gh project field-list "${PROJECT_NUMBER}" --owner "${PROJECT_OWNER}" --format json --jq ".fields[] | select(.name==\"Status\") | .options[] | select(.name==\"${STATUS_NAME}\") | .id")"

          gh project item-edit \
            --id "${ITEM_ID}" \
            --project-id "${PROJECT_ID}" \
            --field-id "${STATUS_FIELD_ID}" \
            --single-select-option-id "${OPTION_ID}"

          echo "Set Status=${STATUS_NAME}."
