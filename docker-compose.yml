services:
  payments-backend:
    # For reproducible deployments, prefer pulling a published image:
    #   PAYMENTS_IMAGE=ghcr.io/its-define/payments-backend:latest
    #   docker compose pull payments-backend && docker compose up -d
    image: ${PAYMENTS_IMAGE:-ghcr.io/its-define/payments-backend:latest}
    build:
      context: .
      dockerfile: Dockerfile
    container_name: payments-backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MONITORED_SERVICES=${MONITORED_SERVICES:-vtuber-unreal-game,vtuber-unreal-signaling,vtuber-turn-server}
      - PAYMENTS_DOCKER_MONITORING_ENABLED=${PAYMENTS_DOCKER_MONITORING_ENABLED:-false}
    user: "1000:1000"
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    volumes:
      - ./data:/app/data
    ports:
      - "8081:8081"
    networks:
      - vtuber_network

  payments-log-collector:
    image: fluent/fluent-bit:2.2
    container_name: payments-log-collector
    restart: unless-stopped
    depends_on:
      - payments-backend
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./data:/var/embody/data:ro
      - ./data/audit:/var/embody/audit
      - ../logging/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
    command: ["fluent-bit", "-c", "/fluent-bit/etc/fluent-bit.conf"]
    networks:
      - vtuber_network

networks:
  vtuber_network:
    driver: bridge
    name: vtuber_network
    driver_opts:
      com.docker.network.bridge.host_binding_ipv4: "0.0.0.0"
