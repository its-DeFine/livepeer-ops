services:
  payments-backend:
    # For reproducible deployments, prefer pulling a published image:
    #   PAYMENTS_IMAGE=ghcr.io/its-define/payments-backend:latest
    #   docker compose pull payments-backend && docker compose up -d
    image: ${PAYMENTS_IMAGE:-ghcr.io/its-define/payments-backend:latest}
    build:
      context: .
      dockerfile: Dockerfile
    container_name: payments-backend
    restart: unless-stopped
    env_file:
      - ${PAYMENTS_ENV_FILE:-.env}
    environment:
      - MONITORED_SERVICES=${MONITORED_SERVICES:-vtuber-unreal-game,vtuber-unreal-signaling,vtuber-turn-server}
      - PAYMENTS_DOCKER_MONITORING_ENABLED=${PAYMENTS_DOCKER_MONITORING_ENABLED:-false}
    user: "1000:1000"
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - ${PAYMENTS_DATA_DIR:-./data}:/app/data
    ports:
      - "${PAYMENTS_PORT:-8081}:8081"
    networks:
      - vtuber_network

  payments-log-collector:
    profiles: ["ops"]
    image: fluent/fluent-bit:2.2
    container_name: payments-log-collector
    restart: unless-stopped
    depends_on:
      - payments-backend
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ${PAYMENTS_DATA_DIR:-./data}:/var/livepeer-ops/data:ro
      - ${PAYMENTS_DATA_DIR:-./data}/audit:/var/livepeer-ops/audit:ro
      - ./ops/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
    command: ["fluent-bit", "-c", "/fluent-bit/etc/fluent-bit.conf"]
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vtuber_network

  payments-checkpoint-witness:
    profiles: ["witness"]
    image: ${PAYMENTS_IMAGE:-ghcr.io/its-define/payments-backend:latest}
    container_name: payments-checkpoint-witness
    restart: unless-stopped
    depends_on:
      - payments-backend
    env_file:
      - ${PAYMENTS_ENV_FILE:-.env}
    command:
      [
        "python",
        "/app/scripts/publish_tee_core_checkpoint.py",
        "--watch",
        "--backend-url",
        "http://payments-backend:8081",
        "--rpc-url",
        "${CHECKPOINT_RPC_URL}",
        "--contract-address",
        "${CHECKPOINT_CONTRACT_ADDRESS}",
        "--chain-id",
        "${CHECKPOINT_CHAIN_ID:-42161}",
        "--interval-seconds",
        "${CHECKPOINT_INTERVAL_SECONDS:-600}"
      ]
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vtuber_network

networks:
  vtuber_network:
    driver: bridge
    name: vtuber_network
    driver_opts:
      com.docker.network.bridge.host_binding_ipv4: "0.0.0.0"
